name: Build all

on:
  workflow_dispatch:
  push:
    branches:
      - master

env:
  CONAN_REVISIONS_ENABLED: 1
  CONAN_SCM_TO_CONANDATA: 1
  CONAN_PASSWORD: ${{ secrets.CONAN_PASSWORD }}
  CONAN_LOGIN_USERNAME: ${{ secrets.CONAN_LOGIN_USERNAME }}

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-20.04, ubuntu-22.04, windows-2019, windows-2022, macos-11, macos-12 ]

    steps:
      - uses: actions/checkout@v3

      - name: Install autotools
        shell: bash
        run: |
          if [[ "$ImageOS" == macos* ]]; then
            brew install autoconf automake
          fi

      - uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install Conan
        shell: bash
        run: |
          pip install -r .github/workflows/requirements.txt
          conan remote add worldforge https://artifactory.ogenvik.org/artifactory/api/conan/conan
          conan profile detect

      - name: Build artifacts
        shell: bash
        run: |
          if [[ x"$CONAN_PASSWORD" != "x" && x"$CONAN_LOGIN_USERNAME" != "x" ]]; then
            conan remove "readline/*" --force
            conan install ./readline -g deploy --build missing && conan create ./readline -pr default
            conan remove "libxdg-basedir/*" --force
            conan install ./libxdg-basedir -g deploy --build missing && conan create ./libxdg-basedir -pr default
            conan remove "pcre/*" --force
            conan install pcre/8.45@_/_ --options "pcre:with_unicode_properties=True" --options "pcre:with_bzip2=False" --build missing
            conan remove "cegui/*" --force
            conan install ./cegui -g deploy --build missing && conan create ./cegui -pr default
            conan remove "ogre/*" --force
            conan install ./ogre -g deploy --build missing && conan create ./ogre -pr default

            conan remote login worldforge $CONAN_LOGIN_USERNAME -p $CONAN_PASSWORD
            conan upload "*" -r worldforge -c
          fi
